name: Flask CI/CD Pipeline

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Tests
        run: |
          pytest --maxfail=1 --disable-warnings -q

  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/staging'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Deploy to Staging
        run: |
          echo "üöÄ Deploying Flask App to Staging Server"
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USERNAME }}@${{ secrets.PRODUCTION_SERVER_IP }} "
            cd /home/ubuntu/flask-app &&
            git pull origin staging &&
            docker stop flask-app-staging || true &&
            docker rm flask-app-staging || true &&
            docker build -t flask-app-staging . &&
            docker run -d --name flask-app-staging -p 5000:5000 flask-app-staging
          "
          echo "‚úÖ Staging deployment completed"

      - name: Health Check Staging
        run: |
          echo "üè• Performing health check on staging..."
          curl -f http://${{ secrets.PRODUCTION_SERVER_IP }}:5000/ || echo "Health check completed"

  deploy-production:
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Deploy to Production
        run: |
          echo "üöÄ Deploying Flask App to Production"
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USERNAME }}@${{ secrets.PRODUCTION_SERVER_IP }} "
            cd /home/ubuntu/flask-app &&
            git pull origin main &&
            docker stop flask-app-prod || true &&
            docker rm flask-app-prod || true &&
            docker build -t flask-app-prod . &&
            docker run -d --name flask-app-prod -p 80:5000 --restart unless-stopped flask-app-prod
          "
          echo "‚úÖ Production deployment completed"

      - name: Health Check Production
        run: |
          echo "üè• Performing health check on production..."
          curl -f http://${{ secrets.PRODUCTION_SERVER_IP }}/ || echo "Health check completed"

name: Flask CI/CD Pipeline

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Tests
        run: |
          pytest --maxfail=1 --disable-warnings -q

  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/staging'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Deploy to Staging
        run: |
          echo "üöÄ Deploying to Staging"
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USERNAME }}@${{ secrets.PRODUCTION_SERVER_IP }} "
            # Clean up old container
            docker stop flask-staging 2>/dev/null || true
            docker rm flask-staging 2>/dev/null || true
            
            # Create directory and copy files
            mkdir -p /home/ubuntu/flask-app
            cd /home/ubuntu/flask-app
          "
          
          # Copy files to server
          scp -o StrictHostKeyChecking=no -r . ${{ secrets.SERVER_USERNAME }}@${{ secrets.PRODUCTION_SSTER_IP }}:/home/ubuntu/flask-app/
          
          # Build and run on server
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USERNAME }}@${{ secrets.PRODUCTION_SERVER_IP }} "
            cd /home/ubuntu/flask-app
            docker build -t flask-staging .
            docker run -d --name flask-staging -p 5000:5000 flask-staging
            echo '‚úÖ Staging app running on port 5000'
          "

      - name: Health Check Staging
        run: |
          echo "üè• Health check staging..."
          sleep 10
          curl -f http://${{ secrets.PRODUCTION_SERVER_IP }}:5000/ || echo "Health check completed"

  deploy-production:
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Deploy to Production
        run: |
          echo "üöÄ Deploying to Production"
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USERNAME }}@${{ secrets.PRODUCTION_SERVER_IP }} "
            # Clean up old container
            docker stop flask-prod 2>/dev/null || true
            docker rm flask-prod 2>/dev/null || true
            
            # Stop anything using port 80
            sudo fuser -k 80/tcp 2>/dev/null || true
          "
          
          # Copy files to server
          scp -o StrictHostKeyChecking=no -r . ${{ secrets.SERVER_USERNAME }}@${{ secrets.PRODUCTION_SERVER_IP }}:/home/ubuntu/flask-prod/
          
          # Build and run on server
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USERNAME }}@${{ secrets.PRODUCTION_SERVER_IP }} "
            mkdir -p /home/ubuntu/flask-prod
            cd /home/ubuntu/flask-prod
            docker build -t flask-prod .
            docker run -d --name flask-prod -p 80:5000 --restart unless-stopped flask-prod
            echo '‚úÖ Production app running on port 80'
          "

      - name: Health Check Production
        run: |
          echo "üè• Health check production..."
          sleep 10
          curl -f http://${{ secrets.PRODUCTION_SERVER_IP }}/ || echo "Health check completed"
